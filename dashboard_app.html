<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XipserCloud - Panel Kontrol Hosting</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            min-height: 100vh;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .card {
            background-color: #ffffff;
            border-radius: 14px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }
        .log-area {
            height: 200px; 
            max-height: 400px; 
            font-family: monospace;
        }
        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-action:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        /* Custom table for Firewall rules */
        .firewall-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: #f3f4f6;
            font-weight: 600;
            font-size: 0.875rem;
            color: #1f2937;
        }
        .firewall-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        .firewall-table tr:hover {
            background-color: #f9fafb;
        }
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
                position: relative;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#059669', /* Emerald Green */
                        'secondary': '#1f2937', /* Dark Gray */
                        'info': '#3b82f6', /* Blue */
                        'success': '#10b981', /* Green */
                        'warning': '#f59e0b', /* Yellow */
                        'danger': '#ef4444', /* Red */
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen">

    <div id="app">
        <!-- Konten akan dimuat di sini -->
    </div>
    
    <!-- Custom Alert Container -->
    <div id="customAlertContainer" class="fixed top-4 right-4 z-50 w-full max-w-sm"></div>

    <script>
        const PORT = 8080;
        const API_BASE_URL = window.location.origin;
        const app = document.getElementById('app');
        let currentView = 'login';
        let sidebarOpen = false;
        let auth = { isAuthenticated: false, username: '' };
        let systemStatus = {};
        let serviceStatus = {
            'Nginx': 'UNKNOWN',
            'MariaDB': 'UNKNOWN',
            'PHP-FPM': 'UNKNOWN'
        };
        let firewallRules = [];

        // --- RENDER & NAVIGATION ---

        function renderLogin() {
            // Mengambil username dari config.json
            const defaultUser = 'superadmin'; 
            const defaultPass = 'sandi-rahasia-anda';
            
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-gray-100">
                    <div class="w-full max-w-xs sm:max-w-sm p-6 sm:p-8 space-y-6 card">
                        <h2 class="text-3xl font-extrabold text-center text-primary">
                            XipserCloud
                        </h2>
                        <p class="text-center text-sm text-gray-500">
                            Akses Panel Kontrol Termux
                        </p>
                        <p class="text-center text-xs text-gray-400 font-semibold p-2 bg-yellow-50 rounded-lg">
                            Kredensial diambil dari: **config.json**
                        </p>
                        <form id="loginForm" class="space-y-4">
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                                <input id="username" type="text" required value="${defaultUser}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary text-secondary">
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input id="password" type="password" required value="${defaultPass}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary text-secondary">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-primary hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                                <span id="loginBtnText">Masuk ke Dashboard</span>
                            </button>
                            <div id="loginMessage" class="text-center text-sm font-medium pt-2" role="alert"></div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        function renderDashboard() {
            let pageContent = '';
            
            if (currentView === 'dashboard') {
                pageContent = renderStatusDashboard();
            } else if (currentView === 'services') {
                pageContent = renderServiceControl();
            } else if (currentView === 'sites') {
                pageContent = renderSiteManagement();
            } else if (currentView === 'dbcli') {
                pageContent = renderDbCli();
            } else if (currentView === 'firewall') {
                pageContent = renderFirewall();
            } else {
                pageContent = `<div class="p-6 text-gray-500">Pilih menu dari samping.</div>`;
            }

            app.innerHTML = `
                <div class="flex min-h-screen">
                    <!-- Sidebar -->
                    <div id="sidebar" class="sidebar fixed inset-y-0 left-0 z-40 w-56 bg-secondary text-white transform md:relative md:translate-x-0 md:flex-shrink-0">
                        <div class="p-4 border-b border-gray-700">
                            <h1 class="text-xl font-bold text-primary">XipserCloud</h1>
                            <p class="text-xs text-gray-400 mt-1">Admin: ${auth.username}</p>
                        </div>
                        <nav class="mt-4 space-y-1">
                            ${renderSidebarLink('Status VPS', 'dashboard', 'M3 10v4m0 0v4m0-4h18m0 0V6')}
                            ${renderSidebarLink('Manajemen Layanan', 'services', 'M4 7h16M4 12h16m-7 5h7')}
                            ${renderSidebarLink('Manajemen Situs', 'sites', 'M5 8h14M5 12h14M5 16h14')}
                            ${renderSidebarLink('Database CLI', 'dbcli', 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0l3 3m0 0l3-3m-3 3v-6a2 2 0 00-2-2h-2a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2z')}
                            ${renderSidebarLink('Firewall (iptables)', 'firewall', 'M13 10V3L4 14h7v7l9-11h-7z')}
                            <a href="#" onclick="handleLogout()" class="block py-2 px-4 hover:bg-red-700 transition duration-150 text-sm mx-2 rounded-lg text-gray-300">
                                <svg class="w-5 h-5 mr-3 inline-block align-middle" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                Logout
                            </a>
                        </nav>
                    </div>

                    <!-- Main Content -->
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <!-- Header Mobile -->
                        <header class="flex items-center justify-between p-4 bg-white border-b border-gray-200 shadow-sm md:hidden">
                            <button id="menuBtn" class="text-gray-500 focus:outline-none">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                            </button>
                            <h2 class="text-lg font-semibold text-secondary">${currentView === 'dashboard' ? 'Status VPS' : currentView === 'services' ? 'Layanan' : currentView === 'sites' ? 'Situs' : currentView === 'dbcli' ? 'Database CLI' : 'Firewall'}</h2>
                            <div class="w-6 h-6"></div>
                        </header>
                        
                        <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 sm:p-6">
                            ${pageContent}
                        </main>
                    </div>
                </div>
            `;
            
            // Re-attach listeners
            if (currentView === 'dashboard') {
                updateStatusDisplay(); 
            } else if (currentView === 'sites') {
                document.getElementById('siteForm').addEventListener('submit', handleSiteCreation);
            } else if (currentView === 'dbcli') {
                document.getElementById('dbCliForm').addEventListener('submit', handleDbExecute);
            } else if (currentView === 'firewall') {
                document.getElementById('addRuleForm').addEventListener('submit', handleAddRule);
                fetchFirewallRules();
            }
            
            document.getElementById('menuBtn')?.addEventListener('click', toggleSidebar);
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    setCurrentView(e.currentTarget.getAttribute('data-view'));
                    if (window.innerWidth < 768) { 
                        toggleSidebar();
                    }
                });
            });
            
            if (currentView === 'services') {
                 fetchServiceStatus();
            }
        }

        function renderSidebarLink(text, view, iconPath) {
            const isActive = currentView === view;
            const activeClasses = isActive ? 'bg-primary text-white font-semibold' : 'text-gray-300 hover:bg-gray-700';
            return `
                <a href="#" data-view="${view}" class="sidebar-link flex items-center py-2 px-4 transition duration-150 text-sm rounded-lg mx-2 ${activeClasses}">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path></svg>
                    ${text}
                </a>
            `;
        }

        function setCurrentView(view) {
            currentView = view;
            renderDashboard();
        }
        
        // (handleLogout, toggleSidebar, renderStatusDashboard, renderStatusCard, renderServiceControl, renderServiceCard, renderSiteManagement, renderDbCli)
        // Dihilangkan untuk keringkasan, diasumsikan sama dengan V2/V3 yang lengkap.

        function renderFirewall() {
            return `
                <h1 class="text-2xl font-bold mb-6 text-secondary">Kontrol Firewall (iptables NYATA)</h1>
                <p class="text-red-600 font-semibold mb-4">PENTING: Aturan ini **HANYA BERSIFAT SEMENTARA** (tidak disimpan saat reboot Termux) dan berjalan pada chain INPUT.</p>
                <p class="text-gray-600 mb-6">Pastikan Anda sudah menginstal paket \`iptables\` atau \`iproute2\` di Termux.</p>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- ADD RULE -->
                    <div class="card p-6 lg:col-span-1">
                        <h2 class="text-xl font-semibold mb-4 text-primary border-b pb-2">Tambah Aturan Baru</h2>
                        <form id="addRuleForm" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Target Aksi</label>
                                <select id="targetAction" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary">
                                    <option value="ACCEPT">ACCEPT (Izinkan)</option>
                                    <option value="DROP">DROP (Blokir)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Protokol</label>
                                <select id="protocol" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary">
                                    <option value="tcp">TCP</option>
                                    <option value="udp">UDP</option>
                                    <option value="all">Semua</option>
                                </select>
                            </div>
                            <div>
                                <label for="port" class="block text-sm font-medium text-gray-700">Port Tujuan (Cth: 80, 22)</label>
                                <input id="port" type="text" placeholder="Port atau Range Port" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 rounded-lg shadow-md text-sm font-medium text-white bg-primary hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                                <span id="addBtnText">Tambahkan Aturan</span>
                            </button>
                        </form>
                    </div>

                    <!-- DELETE RULE / FLUSH -->
                    <div class="card p-6 lg:col-span-2 space-y-4">
                        <h2 class="text-xl font-semibold text-danger border-b pb-2">Hapus Aturan (Line Number)</h2>
                        <div class="flex space-x-2">
                             <input id="deleteLine" type="number" placeholder="Nomor Baris (LINE NUM)" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-danger focus:border-danger" min="1">
                            <button onclick="handleDeleteRule()" class="btn-action bg-danger text-white hover:bg-red-700">
                                Hapus Baris
                            </button>
                        </div>
                        
                        <div class="pt-4">
                            <button onclick="handleFlushRules()" class="btn-action w-full bg-warning text-secondary hover:bg-yellow-600 transition duration-150">
                                FLUSH SEMUA ATURAN (RESET)
                            </button>
                        </div>
                         
                        <div class="card p-4 bg-gray-800 shadow-inner mt-4">
                            <h2 class="text-white font-semibold mb-2">Log Firewall</h2>
                            <pre id="firewallLog" class="log-area text-xs text-orange-400 overflow-y-auto p-2 bg-gray-900 rounded-lg">Log eksekusi iptables akan muncul di sini...</pre>
                        </div>
                    </div>
                </div>

                <!-- LIST RULES -->
                <div class="card p-6 mt-6">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-semibold text-info">Aturan Aktif (Chain INPUT)</h2>
                        <button onclick="fetchFirewallRules(true)" class="btn-action bg-info text-white text-sm hover:bg-blue-700">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.91 8.91 0 0115 20h-5.02m0-16.12A9 9 0 0118 9h-7"></path></svg>
                            Refresh
                        </button>
                    </div>
                    <div id="firewallTableContainer" class="overflow-x-auto">
                        <table id="firewallRulesTable" class="min-w-full divide-y divide-gray-200 firewall-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Target</th>
                                    <th>Protocol</th>
                                    <th>Source</th>
                                    <th>Destination</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat aturan...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }


        // --- FIREWALL API & LOGIC ---
        
        async function fetchFirewallRules(isRefresh = false) {
            const tableBody = document.querySelector('#firewallRulesTable tbody');
            const logArea = document.getElementById('firewallLog');
            
            if (tableBody) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat aturan...</td></tr>`;
            }

            try {
                const response = await postData(`${API_BASE_URL}/api/firewall_command`, { 
                    action: 'list', 
                    username: auth.username, 
                    password: auth.password 
                });
                const result = await response.json();
                
                if (result.status === 'SUCCESS' && Array.isArray(result.rules)) {
                    firewallRules = result.rules;
                    updateFirewallTable(firewallRules);
                    if (isRefresh) showCustomAlert('Daftar aturan diperbarui.', 'bg-info');
                } else {
                    updateFirewallTable([]);
                    logArea.textContent += `\n[ERROR] ${result.message}\nLog: ${result.log || 'N/A'}`;
                    showCustomAlert(`Gagal memuat aturan: ${result.message}`, 'bg-danger');
                }

            } catch (error) {
                updateFirewallTable([]);
                logArea.textContent += `\n[ERROR KRITIS] Gagal terhubung ke API Termux untuk Firewall.`;
            }
        }
        
        function updateFirewallTable(rules) {
            const tableBody = document.querySelector('#firewallRulesTable tbody');
            if (!tableBody) return;

            if (rules.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Tidak ada aturan aktif di Chain INPUT.</td></tr>`;
                return;
            }
            
            // Logika parsing sederhana untuk output iptables -nL --line-numbers
            const lines = firewallRules;
            let html = '';
            for (let i = 1; i < lines.length; i++) { // Baris 0 adalah header, mulai dari 1
                const line = lines[i];
                // Contoh baris: 1    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80
                const parts = line.split(/\s+/).filter(p => p.length > 0);
                
                if (parts.length >= 7) {
                    const lineNumber = parts[0];
                    const target = parts[1];
                    const proto = parts[2];
                    const source = parts[5];
                    const destination = parts[6];

                    // Heuristik untuk DPORT/Sport (Destination Port/Source Port)
                    let portInfo = '';
                    const portMatch = line.match(/dpt:(\S+)/); 
                    if (portMatch) {
                        portInfo = `:${portMatch[1]}`;
                    }

                    html += `
                        <tr>
                            <td class="font-bold text-gray-800">${lineNumber}</td>
                            <td class="font-semibold text-${target === 'ACCEPT' ? 'success' : 'danger'}">${target}</td>
                            <td>${proto}</td>
                            <td>${source}</td>
                            <td>${destination}${portInfo}</td>
                        </tr>
                    `;
                }
            }
            tableBody.innerHTML = html;
        }

        async function handleAddRule(e) {
            e.preventDefault();
            const logArea = document.getElementById('firewallLog');
            const target = document.getElementById('targetAction').value;
            const protocol = document.getElementById('protocol').value;
            const port = document.getElementById('port').value.trim();
            const btn = document.getElementById('addBtnText');

            if (!port) {
                showCustomAlert('Port/IP Sumber wajib diisi.', 'bg-warning');
                return;
            }
            
            btn.textContent = 'Menambahkan...';
            document.querySelector('#addRuleForm button[type="submit"]').disabled = true;

            try {
                const response = await postData(`${API_BASE_URL}/api/firewall_command`, { 
                    action: 'add', 
                    target: target,
                    protocol: protocol,
                    port: port,
                    chain: 'INPUT', 
                    username: auth.username, 
                    password: auth.password
                });
                const result = await response.json();

                logArea.textContent += `\n[${new Date().toLocaleTimeString()}] [${result.status}] ${result.message}\n`;
                logArea.textContent += `${result.log}`;
                logArea.scrollTop = logArea.scrollHeight;

                if (result.status === 'SUCCESS') {
                    showCustomAlert(`Aturan ${target} Port ${port} berhasil.`, 'bg-success');
                    fetchFirewallRules();
                } else {
                    showCustomAlert(`Gagal menambahkan aturan: ${result.message}`, 'bg-danger');
                }
                
            } catch (error) {
                logArea.textContent += `\n[ERROR KRITIS] Gagal terhubung ke API.`;
                showCustomAlert('Koneksi ke server gagal!', 'bg-danger');
            } finally {
                btn.textContent = 'Tambahkan Aturan';
                document.querySelector('#addRuleForm button[type="submit"]').disabled = false;
            }
        }
        
        async function handleDeleteRule() {
            const logArea = document.getElementById('firewallLog');
            const lineNumber = document.getElementById('deleteLine').value.trim();
            
            if (!lineNumber || isNaN(parseInt(lineNumber))) {
                showCustomAlert('Nomor baris harus berupa angka.', 'bg-warning');
                return;
            }

            logArea.textContent += `\n[${new Date().toLocaleTimeString()}] Menghapus aturan baris ke-${lineNumber}...\n`;
            
            try {
                const response = await postData(`${API_BASE_URL}/api/firewall_command`, { 
                    action: 'delete', 
                    line_number: parseInt(lineNumber),
                    chain: 'INPUT', 
                    username: auth.username, 
                    password: auth.password
                });
                const result = await response.json();

                logArea.textContent += `\n[${new Date().toLocaleTimeString()}] [${result.status}] ${result.message}\n`;
                logArea.textContent += `${result.log}`;
                logArea.scrollTop = logArea.scrollHeight;

                if (result.status === 'SUCCESS') {
                    showCustomAlert(`Aturan baris ${lineNumber} berhasil dihapus.`, 'bg-success');
                    document.getElementById('deleteLine').value = '';
                    fetchFirewallRules();
                } else {
                    showCustomAlert(`Gagal menghapus aturan: ${result.message}`, 'bg-danger');
                }
                
            } catch (error) {
                logArea.textContent += `\n[ERROR KRITIS] Gagal terhubung ke API.`;
                showCustomAlert('Koneksi ke server gagal!', 'bg-danger');
            }
        }
        
        async function handleFlushRules() {
             if (!window.confirm("YAKIN? Ini akan menghapus SEMUA aturan di Chain INPUT. Lanjutkan?")) {
                return;
            }

            const logArea = document.getElementById('firewallLog');
            logArea.textContent += `\n[${new Date().toLocaleTimeString()}] Melakukan FLUSH (Reset) Aturan...\n`;
            
            try {
                const response = await postData(`${API_BASE_URL}/api/firewall_command`, { 
                    action: 'flush',
                    username: auth.username, 
                    password: auth.password
                });
                const result = await response.json();

                logArea.textContent += `\n[${new Date().toLocaleTimeString()}] [${result.status}] ${result.message}\n`;
                logArea.textContent += `${result.log}`;
                logArea.scrollTop = logArea.scrollHeight;

                if (result.status === 'SUCCESS') {
                    showCustomAlert(`Semua aturan berhasil di-FLUSH!`, 'bg-success');
                    fetchFirewallRules();
                } else {
                    showCustomAlert(`Gagal FLUSH aturan: ${result.message}`, 'bg-danger');
                }
                
            } catch (error) {
                logArea.textContent += `\n[ERROR KRITIS] Gagal terhubung ke API.`;
                showCustomAlert('Koneksi ke server gagal!', 'bg-danger');
            }
        }
        
        // --- API & DATA HANDLING (Functions from V2/V3 updated for auth) ---
        
        async function postData(url, data) {
            // Ensure auth credentials are sent with every non-login POST request
            if (url !== `${API_BASE_URL}/login` && auth.isAuthenticated) {
                data.username = auth.username;
                data.password = auth.password;
            }
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            // If the server returns 401 for any API call, force logout
            if (response.status === 401 && url !== `${API_BASE_URL}/login`) {
                handleLogout();
            }
            return response;
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const btnText = document.getElementById('loginBtnText');
            const messageDiv = document.getElementById('loginMessage');
            btnText.textContent = 'Memproses...';
            messageDiv.textContent = '';
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await postData(`${API_BASE_URL}/login`, { username, password });
                const result = await response.json();

                if (response.ok) {
                    auth.isAuthenticated = true;
                    auth.username = username; // Simpan username yang valid
                    currentView = 'dashboard';
                    renderDashboard();
                    startStatusUpdater();
                    showCustomAlert('Login berhasil!', 'bg-success');
                } else {
                    messageDiv.className = 'text-center text-sm font-medium pt-2 text-danger';
                    messageDiv.textContent = result.message || 'Login gagal.';
                }
            } catch (error) {
                messageDiv.className = 'text-center text-sm font-medium pt-2 text-danger';
                messageDiv.textContent = 'Tidak dapat terhubung ke server Termux. Pastikan Python berjalan.';
            } finally {
                btnText.textContent = 'Masuk ke Dashboard';
            }
        }

        // (Semua fungsi lain seperti startStatusUpdater, fetchSystemStatus, fetchServiceStatus, 
        // handleServiceCommand, handleSiteCreation, handleDbExecute dihilangkan untuk keringkasan 
        // di sini tetapi diasumsikan ada dan telah dimodifikasi untuk menyertakan auth.username dan auth.password 
        // di setiap payload POST yang dikirim via postData)

        
        // --- Custom Alert/Modal ---
        function showCustomAlert(message, bgColorClass = 'bg-primary') {
            const container = document.getElementById('customAlertContainer');
            const alertDiv = document.createElement('div');
            
            alertDiv.className = `p-4 mt-2 rounded-lg text-white shadow-xl transition-all duration-300 opacity-0 transform translate-x-full ${bgColorClass}`;
            alertDiv.textContent = message;

            container.prepend(alertDiv);
            
            setTimeout(() => {
                alertDiv.classList.remove('opacity-0', 'translate-x-full');
                alertDiv.classList.add('opacity-100', 'translate-x-0');
            }, 50);

            setTimeout(() => {
                alertDiv.classList.remove('opacity-100', 'translate-x-0');
                alertDiv.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => alertDiv.remove(), 300);
            }, 5000); 
        }

        // --- INITIATION ---
        window.onload = renderLogin;
    </script>

    <!-- Placeholder untuk semua fungsi lain yang dihapus untuk keringkasan dalam contoh. 
         Fungsi-fungsi ini harus ada di file akhir Anda, dimodifikasi untuk mengirim auth.username/password. -->
    <script>
        // Placeholder definitions for completeness
        function get_local_ip() { return '127.0.0.1'; }
        function startStatusUpdater() {}
        function fetchSystemStatus() {}
        function updateStatusDisplay() {}
        function fetchServiceStatus() {}
        function handleServiceCommand() {}
        function handleSiteCreation() {}
        function handleDbExecute() {}
        function handleLogout() {
            showCustomAlert('Anda telah logout.', 'bg-danger');
            auth = { isAuthenticated: false, username: '' };
            currentView = 'login';
            // clearInterval(statusInterval); // Uncomment if statusInterval is defined
            renderLogin();
        }
        function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            const sidebarElement = document.getElementById('sidebar');
            if (sidebarElement) {
                if (sidebarOpen) {
                    sidebarElement.classList.add('open');
                } else {
                    sidebarElement.classList.remove('open');
                }
            }
        }
    </script>
</body>
</html>

